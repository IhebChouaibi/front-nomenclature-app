<app-navbar></app-navbar>
<div class="container">
  <app-sidebar 
    (chapitreSelected)="onChapitreSelected($event)"
    class="sidebar">
  </app-sidebar>
  
  <div class="main-content">
   

    <div *ngIf="selectedChapitre">
      <h2 class="hierarchy-title">
        Hi√©rarchie pour : <span class="chapter-name">{{ selectedChapitre.libelleChapitre }}</span>
      </h2>

      <div *ngFor="let position of selectedChapitre.positions" class="hierarchy-container">
        <div class="hierarchy-item"
          (click)="togglePosition(position.idPosition)"
          [class.selected]="state.expandedPositionId === position.idPosition">

          <div class="item-left">
            <span class="toggle-icon">
              {{ state.expandedPositionId === position.idPosition ? 'üóÅ' : 'üóÄ' }}
            </span>
            <span>
              {{ position.codePosition }} - {{ position.libellePosition }}
            </span>
          </div>

          <div class="item-right" *ngIf="auth.getRole() === 'ADMIN'">
            <button mat-button 
              [matMenuTriggerFor]="menuPosition"
              (click)="$event.stopPropagation()">
             ‚ãÆ
            </button>
          </div>

          <mat-menu #menuPosition="matMenu">
            <button mat-menu-item (click)="addMesureForPosition(position); $event.stopPropagation()">
              Add Mesure
            </button>
                      <button mat-menu-item (click)="addNoteToPosition(position); $event.stopPropagation()">
              Add Note
            </button>

          </mat-menu>
        </div>
       <mat-divider style="width: 10px;"></mat-divider>

        <div *ngIf="state.expandedPositionId === position.idPosition">
          <div *ngFor="let sousPosition of position.sousPositions" class="hierarchy-item sous-position"
            (click)="toggleSousPosition(sousPosition.idSousPosition)"
            [class.selected]="state.expandedSousPositionId === sousPosition.idSousPosition">

            <div class="item-left">
              <span class="toggle-icon">
                {{ state.expandedSousPositionId === sousPosition.idSousPosition ? 'üóÅ':'üóÄ' }}
              </span>
              <span>
                {{ sousPosition.codeSousPosition }} - {{ sousPosition.libelleSousPosition }}
              </span>
            </div>

            <div class="item-right" *ngIf="auth.getRole() === 'ADMIN'">
              <button mat-button 
                [matMenuTriggerFor]="menuSousPosition"
                (click)="$event.stopPropagation()">
                ‚ãÆ
              </button>
            </div>

            <mat-menu #menuSousPosition="matMenu" >
              <button mat-menu-item (click)="addMesureForSousPosition(sousPosition); $event.stopPropagation()">
               Add Mesure
              </button>
             <button mat-menu-item (click)="addNoteToSousPosition(sousPosition); $event.stopPropagation()">
             Add Note
              </button>
            </mat-menu>

            <div *ngIf="state.expandedSousPositionId === sousPosition.idSousPosition">
              <div *ngFor="let nc of sousPosition.nomenclatureCombinees" class="hierarchy-item nc"
                (click)="toggleNc(nc.idNCombinee); $event.stopPropagation()"
                [class.selected]="state.expandedNcId === nc.idNCombinee">

                <div class="item-left">
                  <span class="toggle-icon">
                    {{ state.expandedNcId === nc.idNCombinee ? 'üóÅ':'üóÄ' }}
                  </span>
                  <span>{{ nc.codeNCombinee }}</span>
                </div>

                <div class="item-right" *ngIf="auth.getRole() === 'ADMIN'">
                  <button mat-button 
                    [matMenuTriggerFor]="menuNc"
                    (click)="$event.stopPropagation()">
                    ‚ãÆ
                  </button>
                </div>

                <mat-menu #menuNc="matMenu" >
                  <button mat-menu-item>
                    ‚ûï Mesure pour cette NC
                  </button>
                  <button mat-menu-item (click)="$event.stopPropagation()">
                    ‚öôÔ∏è Autre M√©thode
                  </button>
                </mat-menu>

                <div *ngIf="state.expandedNcId === nc.idNCombinee">
                  <div *ngFor="let taric of nc.nomenclatures" class="hierarchy-item taric"
                    (click)="openInfoDialog(taric); $event.stopPropagation()">
                    {{ taric.codeNomenclature }} - {{ suffixMap[taric.idSuffix] }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!selectedChapitre" class="placeholder">
      <p>S√©lectionnez un chapitre pour afficher la hi√©rarchie compl√®te</p>
    </div>
  </div>
</div>
